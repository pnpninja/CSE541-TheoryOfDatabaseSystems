CONNECT TO SAMPLE;
WITH NYZIPS(ZZ) AS (SELECT DISTINCT(SUBSTR(ZIPCODE,1,5)) FROM CSE532.FACILITYCERTIFICATION INNER JOIN CSE532.FACILITY ON CSE532.FACILITY.FACILITYID = CSE532.FACILITYCERTIFICATION.FACILITYID),NEIGHBORHOOD_TABLE(ZIP,NEIGHBOR) AS (SELECT DISTINCT substr(a.GEOID10,1,5) AS ZIP, substr(b.GEOID10,1,5) AS Neighbor FROM CSE532.USZIP a, CSE532.USZIP b WHERE db2gse.st_intersects(a.SHAPE,b.SHAPE) = 1 AND SUBSTR(a.GEOID10,1,5) IN (SELECT * FROM NYZIPS) AND SUBSTR(b.GEOID10,1,5) IN (SELECT * FROM NYZIPS) ORDER BY substr(a.GEOID10,1,5)),ZIPS_WITH_NO_ER (ZIPCODE) AS (SELECT DISTINCT(SUBSTR(ZIPCODE,1,5)) FROM CSE532.FACILITY WHERE SUBSTR(ZIPCODE,1,5) NOT IN (SELECT DISTINCT(SUBSTR(ZIPCODE,1,5)) FROM CSE532.FACILITYCERTIFICATION INNER JOIN CSE532.FACILITY ON CSE532.FACILITY.FACILITYID = CSE532.FACILITYCERTIFICATION.FACILITYID WHERE CSE532.FACILITYCERTIFICATION.ATTRIBUTEVALUE = 'Emergency Department')) SELECT n.ZIP FROM NEIGHBORHOOD_TABLE n LEFT JOIN ZIPS_WITH_NO_ER b ON b.ZIPCODE = n.NEIGHBOR GROUP BY n.ZIP HAVING MAX(b.ZIPCODE IS NULL) = 0;
